#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Running pre-commit checks...${NC}\n"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|json|css|scss|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo -e "${BLUE}‚ÑπÔ∏è  No staged files to check${NC}"
  exit 0
fi

# Step 1: Run Prettier
echo -e "${BLUE}üìù Step 1/3: Formatting code with Prettier...${NC}"
echo "$STAGED_FILES" | xargs npx prettier --write 2>&1
PRETTIER_EXIT_CODE=$?

if [ $PRETTIER_EXIT_CODE -eq 0 ]; then
  echo -e "${GREEN}‚úÖ Prettier formatting completed${NC}\n"
else
  echo -e "${RED}‚ùå Prettier formatting failed${NC}\n"
  exit 1
fi

# Stage files again after prettier formatting (in case they were modified)
echo "$STAGED_FILES" | xargs git add 2>/dev/null || true

# Step 2: Run ESLint fix
echo -e "${BLUE}üîß Step 2/3: Fixing linting issues with ESLint...${NC}"
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -n "$TS_FILES" ]; then
  echo "$TS_FILES" | xargs npx eslint --fix 2>&1
  ESLINT_FIX_EXIT_CODE=$?

  if [ $ESLINT_FIX_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ ESLint auto-fix completed${NC}\n"
  else
    echo -e "${YELLOW}‚ö†Ô∏è  Some issues could not be auto-fixed${NC}\n"
  fi

  # Stage files again after eslint fix (in case they were modified)
  echo "$TS_FILES" | xargs git add 2>/dev/null || true
else
  echo -e "${BLUE}‚ÑπÔ∏è  No TypeScript files to lint${NC}\n"
  ESLINT_FIX_EXIT_CODE=0
fi

# Step 3: Check for remaining ESLint errors (non-fixable)
echo -e "${BLUE}üîç Step 3/3: Checking for non-fixable linting errors...${NC}"
if [ -n "$TS_FILES" ]; then
  echo "$TS_FILES" | xargs npx eslint --max-warnings 0 2>&1
  ESLINT_CHECK_EXIT_CODE=$?

  if [ $ESLINT_CHECK_EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No linting errors found${NC}\n"
    echo -e "${GREEN}‚ú® All pre-commit checks passed!${NC}"
    exit 0
  else
    echo -e "${RED}‚ùå Found non-fixable linting errors${NC}"
    echo -e "${RED}üö´ Commit cancelled. Please fix the errors above and try again.${NC}"
    exit 1
  fi
else
  echo -e "${GREEN}‚úÖ No TypeScript files to check${NC}\n"
  echo -e "${GREEN}‚ú® All pre-commit checks passed!${NC}"
  exit 0
fi
